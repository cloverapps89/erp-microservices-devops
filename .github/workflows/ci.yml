name: build-and-test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout repo
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 📦 Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 🎼 Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version


      - name: 🐳 Start services with Docker Compose
        run: docker-compose up -d --build

      - name: ⏳ Wait for services to be healthy
        run: |
          echo "Waiting for inventory-service..."
          until curl -s http://localhost:8000/health; do sleep 2; done
          echo "Waiting for orders-service..."
          until curl -s http://localhost:8001/health; do sleep 2; done
          echo "✅ All services are healthy."

      - name: 🧪 Run integration tests
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install -r inventory-service/requirements.txt
          pip install -r orders-service/requirements.txt
          pip install pytest requests
          echo "Testing inventory-service..."
          pytest -v inventory-service/tests
          echo "Testing orders-service..."
          pytest -v orders-service/tests

      - name: 🧹 Tear down services
        if: always()
        run: docker-compose down
